@model ProjectPlanning.Web.Models.Project

@{
    ViewData["Title"] = "Create Project";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f7f8fa;
            min-height: 100vh;
            padding-top: 80px;
            font-family: 'Segoe UI', sans-serif;
        }

        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .container {
            max-width: 700px;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .resource-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .resource-item input {
            flex: 1;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light d-flex justify-content-between px-4 py-2">
        <span class="navbar-brand mb-0 h5">Project Planning - Crear Proyecto</span>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Cerrar sesi√≥n</button>
    </nav>

    <div class="container mt-4">
        <h2>üì¢ Crear Proyecto</h2>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">
                @TempData["SuccessMessage"]
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">
                @TempData["ErrorMessage"]
            </div>
        }

        <form asp-action="Create" method="post">
            <div class="form-group mb-3">
                <label asp-for="Name" class="form-label">Nombre del Proyecto</label>
                <input asp-for="Name" class="form-control" maxlength="30" required />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="StartDate" class="form-label">Fecha de Inicio</label>
                <input asp-for="StartDate" type="date" class="form-control" required />
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="EndDate" class="form-label">Fecha de Fin</label>
                <input asp-for="EndDate" type="date" class="form-control" required />
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Recursos Necesarios</label>
                <div id="resource-list">
                    @if (Model?.Resources != null && Model.Resources.Count > 0) {
                        @for (int i = 0; i < Model.Resources.Count; i++)
                        {
                            <div class="resource-item" id="resource-@i">
                                <input type="text" 
                                    name="Resources[@i]" 
                                    value="@Model.Resources[i]" 
                                    class="form-control" 
                                    placeholder="Descripci√≥n del recurso" 
                                    maxlength="100" />
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeResource(@i)">Eliminar</button>
                            </div>
                        }
                    }
                </div>
                <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addResource()">+ Agregar Recurso</button>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="submit" class="btn btn-primary">üíæ Guardar Proyecto</button>
                <button type="button" class="btn btn-outline-secondary" onclick="goBack()">‚Üê Volver</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Verificar sesi√≥n de Bonita
        function checkBonitaSession() {
            const sessionId = localStorage.getItem("bonitaSessionId");
            const apiToken = localStorage.getItem("bonitaApiToken");
            const rolesJson = localStorage.getItem("bonitaRoles");

            console.log("Verificando sesi√≥n Bonita en Create...");
            console.log("SessionId:", sessionId ? "‚úì" : "‚úó");
            console.log("ApiToken:", apiToken ? "‚úì" : "‚úó");

            // Si no hay sesi√≥n, redirigir a login
            if (!sessionId || !apiToken) {
                console.warn("No hay sesi√≥n, redirigiendo a login...");
                window.location.href = "/AuthView/Login";
                return false;
            }

            const roles = JSON.parse(rolesJson || "[]");
            console.log("Roles:", roles);

            // Verificar que tiene rol de offering projects
            const hasOfferingRole = roles.some(r => 
                String(r).toLowerCase().includes("offering_projects")
            );

            if (!hasOfferingRole) {
                console.warn("Usuario NO tiene permiso para crear proyectos, redirigiendo...");
                window.location.href = "/AuthView/ProjectList";
                return false;
            }

            return true;
        }

        function logout() {
            console.log("Cerrando sesi√≥n...");
            localStorage.clear();
            window.location.href = "/AuthView/Login";
        }

        function goBack() {
            window.location.href = "/AuthView/OngMenu";
        }

        // Verificar sesi√≥n al cargar la p√°gina
        if (!checkBonitaSession()) {
            // Si falla la verificaci√≥n, ya redirigi√≥
        }

        // Gesti√≥n de recursos din√°micos
        let resourceIndex = @(Model?.Resources?.Count ?? 0);

        function addResource() {
            const container = document.getElementById('resource-list');

            const div = document.createElement('div');
            div.classList.add('resource-item');
            div.id = `resource-${resourceIndex}`;

            const input = document.createElement('input');
            input.type = 'text';
            input.name = `Resources[${resourceIndex}]`;
            input.placeholder = 'Descripci√≥n del recurso';
            input.classList.add('form-control');
            input.maxLength = 100;
            input.required = true;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.classList.add('btn', 'btn-danger', 'btn-sm');
            removeBtn.innerText = 'Eliminar';

            const currentIndex = resourceIndex;
            removeBtn.onclick = () => removeResource(currentIndex);

            div.appendChild(input);
            div.appendChild(removeBtn);
            container.appendChild(div);

            resourceIndex++;
        }

        function removeResource(index) {
            const element = document.getElementById(`resource-${index}`);
            if (element) element.remove();
        }

        // Validaci√≥n del formulario
        document.querySelector('form').addEventListener('submit', function(event) {
            const resources = document.querySelectorAll('#resource-list input[type="text"]');
            
            if (resources.length === 0) {
                alert('‚ö†Ô∏è Debes agregar al menos un recurso.');
                event.preventDefault();
                return;
            }

            for (let i = 0; i < resources.length; i++) {
                if (!resources[i].value.trim()) {
                    alert(`‚ö†Ô∏è El recurso n√∫mero ${i + 1} no puede estar vac√≠o.`);
                    event.preventDefault();
                    return;
                }
            }
        });
    </script>
</body>
</html>
